/* Generated by the heythings model compiler.  DO NOT EDIT! */
/* Generated from: ahu.proto */

#include <errno.h>
#include <assert.h>
#include "ahu.pb-c.h"
#include "ahu_service.h"
#include "hey/schema.h"

#define AHU_SERVICE 
#define PROP_IID_CNT 29
#define ACT_IID_CNT 1
#define EV_IID_CNT 1

static const struct hey_schema_property ahu_properties_iids[] = {
    [0] = { .iid = 1, .type = HEY_PROPERTY_TYPE_GENERIC },
    [1] = { .iid = 2, .type = HEY_PROPERTY_TYPE_GENERIC },
    [2] = { .iid = 3, .type = HEY_PROPERTY_TYPE_GENERIC },
    [3] = { .iid = 4, .type = HEY_PROPERTY_TYPE_GENERIC },
    [4] = { .iid = 5, .type = HEY_PROPERTY_TYPE_GENERIC },
    [5] = { .iid = 6, .type = HEY_PROPERTY_TYPE_GENERIC },
    [6] = { .iid = 7, .type = HEY_PROPERTY_TYPE_GENERIC },
    [7] = { .iid = 8, .type = HEY_PROPERTY_TYPE_GENERIC },
    [8] = { .iid = 9, .type = HEY_PROPERTY_TYPE_GENERIC },
    [9] = { .iid = 10, .type = HEY_PROPERTY_TYPE_GENERIC },
    [10] = { .iid = 11, .type = HEY_PROPERTY_TYPE_GENERIC },
    [11] = { .iid = 12, .type = HEY_PROPERTY_TYPE_GENERIC },
    [12] = { .iid = 13, .type = HEY_PROPERTY_TYPE_GENERIC },
    [13] = { .iid = 14, .type = HEY_PROPERTY_TYPE_GENERIC },
    [14] = { .iid = 15, .type = HEY_PROPERTY_TYPE_GENERIC },
    [15] = { .iid = 16, .type = HEY_PROPERTY_TYPE_GENERIC },
    [16] = { .iid = 17, .type = HEY_PROPERTY_TYPE_GENERIC },
    [17] = { .iid = 18, .type = HEY_PROPERTY_TYPE_GENERIC },
    [18] = { .iid = 19, .type = HEY_PROPERTY_TYPE_GENERIC },
    [19] = { .iid = 20, .type = HEY_PROPERTY_TYPE_GENERIC },
    [20] = { .iid = 21, .type = HEY_PROPERTY_TYPE_GENERIC },
    [21] = { .iid = 22, .type = HEY_PROPERTY_TYPE_GENERIC },
    [22] = { .iid = 23, .type = HEY_PROPERTY_TYPE_GENERIC },
    [23] = { .iid = 24, .type = HEY_PROPERTY_TYPE_GENERIC },
    [24] = { .iid = 25, .type = HEY_PROPERTY_TYPE_GENERIC },
    [25] = { .iid = 26, .type = HEY_PROPERTY_TYPE_GENERIC },
    [26] = { .iid = 27, .type = HEY_PROPERTY_TYPE_GENERIC },
    [27] = { .iid = 28, .type = HEY_PROPERTY_TYPE_GENERIC },
    [28] = { .iid = 29, .type = HEY_PROPERTY_TYPE_GENERIC },
};
static const uint32_t ahu_event_iids[] = { 30 };
static struct hey_service *ahu_service;

static int32_t action_device_reboot_start_cb(void *cb_data, struct hey_action_ctx *ctx, size_t len, uint8_t *value, void **user_context)
{
    int32_t ret = -1;
    Iot__Service__Ahu__ActionInDeviceReboot *device_reboot = iot__service__ahu__action_in_device_reboot__unpack(NULL, len, value);
    if (NULL == device_reboot) {
        hey_action_stop(ctx);
        return EINVAL;
    }

    struct ahu_device_reboot_in action = { 0 };
    ret = ahu_device_reboot_start_cb(ctx, &action, user_context);

    iot__service__ahu__action_in_device_reboot__free_unpacked(device_reboot, NULL);
    return ret;
}

static void action_device_reboot_stop_cb(void *cb_data, void *user_context)
{
    ahu_device_reboot_stop_cb(user_context);
}

/**
 * @brief device reboot action send message of ahu service
 * @param ctx      [action context]
 * @param action   [device reboot action out]
 * @return int32_t [action send result, 0 means success]
 */
int32_t ahu_device_reboot_send(struct hey_action_ctx *ctx, struct ahu_device_reboot_out *action)
{
    return hey_action_msg_send(ctx, 0, NULL);
}

/**
 * @brief device reboot action stop of ahu service
 * @param ctx      [action context]
 * @return int32_t [action stop result, 0 means success]
 */
int32_t ahu_device_reboot_stop(struct hey_action_ctx *ctx)
{
    return hey_action_stop(ctx);
}

static int32_t service_ahu_properties_write_cb(void *cb_data, size_t n_iid, uint32_t *iids,
                                               size_t len, uint8_t *value)
{
    Iot__Service__Ahu__Properties *props = iot__service__ahu__properties__unpack(NULL, len, value);
    if (NULL == props) {
        return EINVAL;
    }

    int32_t ret = 0;
    struct ahu_properties properties = { 0 };
    properties.primaryfiltersta = props->primaryfiltersta;
    properties.mediumfiltersta = props->mediumfiltersta;
    properties.finalfiltersta = props->finalfiltersta;
    properties.elecprecipitatorfault = props->elecprecipitatorfault;
    properties.elecprecipitatorpower = props->elecprecipitatorpower;
    properties.coolingvlvfeedback1 = props->coolingvlvfeedback1;
    properties.coolingvlvfeedback2 = props->coolingvlvfeedback2;
    properties.coolingvlvopening1 = props->coolingvlvopening1;
    properties.coolingvlvopening2 = props->coolingvlvopening2;
    properties.heatingvlvfeedback = props->heatingvlvfeedback;
    properties.heatingvlvopening = props->heatingvlvopening;
    properties.humidifierpower = props->humidifierpower;
    properties.humidifiersfault = props->humidifiersfault;
    properties.elecheatingfault1 = props->elecheatingfault1;
    properties.elecheatingmannulautosta1 = props->elecheatingmannulautosta1;
    properties.elecheatingpower1 = props->elecheatingpower1;
    properties.elecheatingtemp1 = props->elecheatingtemp1;
    properties.elecheatingfault2 = props->elecheatingfault2;
    properties.elecheatingmannulautosta2 = props->elecheatingmannulautosta2;
    properties.elecheatingpower2 = props->elecheatingpower2;
    properties.elecheatingtemp2 = props->elecheatingtemp2;
    properties.elecheatingpower3 = props->elecheatingpower3;
    properties.elecheatingfault3 = props->elecheatingfault3;
    properties.maxhumidity = props->maxhumidity;
    properties.elecheatingtempthreshold = props->elecheatingtempthreshold;
    properties.mincoolingvlvtemp = props->mincoolingvlvtemp;
    properties.highpreshumidification = props->highpreshumidification;
    properties.humidifieropeningfeedback = props->humidifieropeningfeedback;
    properties.humidifieropening = props->humidifieropening;
    ret = ahu_properties_write_cb(n_iid, iids, &properties);

    iot__service__ahu__properties__free_unpacked(props, NULL);
    return ret;
}

static const struct hey_properties_callbacks props_cbs = {
    .write = service_ahu_properties_write_cb
};

static const struct hey_action_ctx_callbacks device_reboot_cbs = {
    .start = action_device_reboot_start_cb,
    .stop = action_device_reboot_stop_cb
};

static const struct hey_action_entry actions_iids[] = {
    [0] = { .iid = AHU_ACTION_DEVICE_REBOOT, .type = HEY_ACTION_ONCE, .cbs = &device_reboot_cbs },
};

static int ahu_service_register(Iot__Service__Ahu__Properties *props)
{
    uint8_t *buf;
    size_t buf_len;
    buf_len = iot__service__ahu__properties__get_packed_size(props);
    if (buf_len == 0) {
        buf = NULL;
    } else {
        buf = malloc(buf_len);
        if (!buf) {
            return ENOMEM;
        }
        iot__service__ahu__properties__pack(props, buf);
    }

    struct hey_schema_service schema_srv;
    hey_schema_service_init(&schema_srv);
    schema_srv.properties.iids = (struct hey_schema_property *)ahu_properties_iids;
    schema_srv.properties.n_iid = PROP_IID_CNT;
    schema_srv.properties.value = buf;
    schema_srv.properties.len = buf_len;
    schema_srv.properties.cbs = &props_cbs;
    schema_srv.actions.iids = (struct hey_action_entry *)actions_iids;
    schema_srv.actions.n_iid = ACT_IID_CNT;
    schema_srv.events.iids = (uint32_t *)ahu_event_iids;
    schema_srv.events.n_iid = EV_IID_CNT;
    ahu_service = hey_service_register(AHU_SERVICE, &schema_srv, NULL);
    if (NULL == ahu_service) {
        free(buf);
        return errno;
    }

    free(buf);
    return 0;
}

/**
 * @brief update properties of ahu service
 * @param count      [the number of properties to be updated]
 * @param enumerate  [the iid enumeration of properties to be updated]
 * @param properties [properties structure with updated content]
 * @return int32_t   [update result]
 */
int32_t ahu_properties_update(size_t count, uint32_t *enumerate, struct ahu_properties *properties)
{
    assert(count <= PROP_IID_CNT);
    if (NULL == properties) {
        return EINVAL;
    }

    int ret = 0;
    Iot__Service__Ahu__Properties *props = NULL;
    uint8_t *buf = NULL;
    props = malloc(sizeof(Iot__Service__Ahu__Properties));
    if (NULL == props) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__ahu__properties__init(props);
    props->primaryfiltersta = properties->primaryfiltersta;
    props->mediumfiltersta = properties->mediumfiltersta;
    props->finalfiltersta = properties->finalfiltersta;
    props->elecprecipitatorfault = properties->elecprecipitatorfault;
    props->elecprecipitatorpower = properties->elecprecipitatorpower;
    props->coolingvlvfeedback1 = properties->coolingvlvfeedback1;
    props->coolingvlvfeedback2 = properties->coolingvlvfeedback2;
    props->coolingvlvopening1 = properties->coolingvlvopening1;
    props->coolingvlvopening2 = properties->coolingvlvopening2;
    props->heatingvlvfeedback = properties->heatingvlvfeedback;
    props->heatingvlvopening = properties->heatingvlvopening;
    props->humidifierpower = properties->humidifierpower;
    props->humidifiersfault = properties->humidifiersfault;
    props->elecheatingfault1 = properties->elecheatingfault1;
    props->elecheatingmannulautosta1 = properties->elecheatingmannulautosta1;
    props->elecheatingpower1 = properties->elecheatingpower1;
    props->elecheatingtemp1 = properties->elecheatingtemp1;
    props->elecheatingfault2 = properties->elecheatingfault2;
    props->elecheatingmannulautosta2 = properties->elecheatingmannulautosta2;
    props->elecheatingpower2 = properties->elecheatingpower2;
    props->elecheatingtemp2 = properties->elecheatingtemp2;
    props->elecheatingpower3 = properties->elecheatingpower3;
    props->elecheatingfault3 = properties->elecheatingfault3;
    props->maxhumidity = properties->maxhumidity;
    props->elecheatingtempthreshold = properties->elecheatingtempthreshold;
    props->mincoolingvlvtemp = properties->mincoolingvlvtemp;
    props->highpreshumidification = properties->highpreshumidification;
    props->humidifieropeningfeedback = properties->humidifieropeningfeedback;
    props->humidifieropening = properties->humidifieropening;

    size_t buf_len;
    buf_len = iot__service__ahu__properties__get_packed_size(props);
    if (buf_len > 0) {
        buf = malloc(buf_len);
        if (NULL == buf) {
            ret = ENOMEM;
            goto out;
        }
        iot__service__ahu__properties__pack(props, buf);
    }

    struct hey_properties_content content = {
        .n_iid = count,
        .iids = enumerate,
        .len = buf_len,
        .value = buf
    };
    ret = hey_properties_update(ahu_service, &content);

out:
    free(props);
    free(buf);
    return ret;
}

/**
 * @brief ahu service initialization
 * @param properties [ahu service properties]
 * @return int32_t   [initialize result]
*/
int32_t ahu_service_init(const struct ahu_properties *properties)
{
    int ret = 0;
    Iot__Service__Ahu__Properties *props = NULL;
    props = malloc(sizeof(Iot__Service__Ahu__Properties));
    if (NULL == props) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__ahu__properties__init(props);
    if (NULL != properties) {
        props->primaryfiltersta = properties->primaryfiltersta;
        props->mediumfiltersta = properties->mediumfiltersta;
        props->finalfiltersta = properties->finalfiltersta;
        props->elecprecipitatorfault = properties->elecprecipitatorfault;
        props->elecprecipitatorpower = properties->elecprecipitatorpower;
        props->coolingvlvfeedback1 = properties->coolingvlvfeedback1;
        props->coolingvlvfeedback2 = properties->coolingvlvfeedback2;
        props->coolingvlvopening1 = properties->coolingvlvopening1;
        props->coolingvlvopening2 = properties->coolingvlvopening2;
        props->heatingvlvfeedback = properties->heatingvlvfeedback;
        props->heatingvlvopening = properties->heatingvlvopening;
        props->humidifierpower = properties->humidifierpower;
        props->humidifiersfault = properties->humidifiersfault;
        props->elecheatingfault1 = properties->elecheatingfault1;
        props->elecheatingmannulautosta1 = properties->elecheatingmannulautosta1;
        props->elecheatingpower1 = properties->elecheatingpower1;
        props->elecheatingtemp1 = properties->elecheatingtemp1;
        props->elecheatingfault2 = properties->elecheatingfault2;
        props->elecheatingmannulautosta2 = properties->elecheatingmannulautosta2;
        props->elecheatingpower2 = properties->elecheatingpower2;
        props->elecheatingtemp2 = properties->elecheatingtemp2;
        props->elecheatingpower3 = properties->elecheatingpower3;
        props->elecheatingfault3 = properties->elecheatingfault3;
        props->maxhumidity = properties->maxhumidity;
        props->elecheatingtempthreshold = properties->elecheatingtempthreshold;
        props->mincoolingvlvtemp = properties->mincoolingvlvtemp;
        props->highpreshumidification = properties->highpreshumidification;
        props->humidifieropeningfeedback = properties->humidifieropeningfeedback;
        props->humidifieropening = properties->humidifieropening;
    }

    ret = ahu_service_register(props);

out:
    free(props);
    return ret;
}

/**
 * @brief high temp alarm notify of ahu service
 * @param event    [event content]
 * @param attr     [event details]
 * @return int64_t [event uuid, get error code from errno when return negative value]
*/
int64_t ahu_high_temp_alarm_notify(struct ahu_event_high_temp_alarm *event, struct hey_event_notify_attr *attr)
{
    int64_t ret = -1;

    struct hey_event_notify_content content = {
        .iid = AHU_EVENT_HIGH_TEMP_ALARM,
        .importance = attr->importance,
        .uuid = attr->uuid,
        .ref_uuid = attr->ref_uuid,
        .timestamp = attr->timestamp,
        .len = 0,
        .value = NULL,
    };
    ret = hey_event_notify(ahu_service, &content, ahu_high_temp_alarm_notify_result_cb, attr->ctx);

    return ret;
}
