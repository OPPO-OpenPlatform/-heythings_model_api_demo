/* Generated by the heythings model compiler.  DO NOT EDIT! */
/* Generated from: toothbrush.proto */

#include <errno.h>
#include <assert.h>
#include "toothbrush.pb-c.h"
#include "toothbrush_service.h"
#include "hey/schema.h"

#define TOOTHBRUSH_SERVICE 
#define PROP_IID_CNT 12
#define ACT_IID_CNT 3

static const struct hey_schema_property toothbrush_properties_iids[] = {
    [0] = { .iid = 1, .type = HEY_PROPERTY_TYPE_GENERIC },
    [1] = { .iid = 3, .type = HEY_PROPERTY_TYPE_GENERIC },
    [2] = { .iid = 4, .type = HEY_PROPERTY_TYPE_GENERIC },
    [3] = { .iid = 5, .type = HEY_PROPERTY_TYPE_GENERIC },
    [4] = { .iid = 6, .type = HEY_PROPERTY_TYPE_GENERIC },
    [5] = { .iid = 7, .type = HEY_PROPERTY_TYPE_GENERIC },
    [6] = { .iid = 8, .type = HEY_PROPERTY_TYPE_GENERIC },
    [7] = { .iid = 9, .type = HEY_PROPERTY_TYPE_GENERIC },
    [8] = { .iid = 10, .type = HEY_PROPERTY_TYPE_GENERIC },
    [9] = { .iid = 11, .type = HEY_PROPERTY_TYPE_GENERIC },
    [10] = { .iid = 12, .type = HEY_PROPERTY_TYPE_GENERIC },
    [11] = { .iid = 13, .type = HEY_PROPERTY_TYPE_GENERIC },
};
static struct hey_service *toothbrush_service;

static int32_t action_toothbrush_head_reset_start_cb(void *cb_data, struct hey_action_ctx *ctx, size_t len, uint8_t *value, void **user_context)
{
    int32_t ret = -1;
    Iot__Service__Toothbrush__ActionInToothbrushHeadReset *toothbrush_head_reset = iot__service__toothbrush__action_in_toothbrush_head_reset__unpack(NULL, len, value);
    if (NULL == toothbrush_head_reset) {
        hey_action_stop(ctx);
        return EINVAL;
    }

    struct toothbrush_toothbrush_head_reset_in action = { 0 };
    ret = toothbrush_toothbrush_head_reset_start_cb(ctx, &action, user_context);

    iot__service__toothbrush__action_in_toothbrush_head_reset__free_unpacked(toothbrush_head_reset, NULL);
    return ret;
}

static void action_toothbrush_head_reset_stop_cb(void *cb_data, void *user_context)
{
    toothbrush_toothbrush_head_reset_stop_cb(user_context);
}

/**
 * @brief toothbrush head reset action send message of toothbrush service
 * @param ctx      [action context]
 * @param action   [toothbrush head reset action out]
 * @return int32_t [action send result, 0 means success]
 */
int32_t toothbrush_toothbrush_head_reset_send(struct hey_action_ctx *ctx, struct toothbrush_toothbrush_head_reset_out *action)
{
    return hey_action_msg_send(ctx, 0, NULL);
}

/**
 * @brief toothbrush head reset action stop of toothbrush service
 * @param ctx      [action context]
 * @return int32_t [action stop result, 0 means success]
 */
int32_t toothbrush_toothbrush_head_reset_stop(struct hey_action_ctx *ctx)
{
    return hey_action_stop(ctx);
}

static int32_t action_get_three_axis_offline_brushing_details_start_cb(void *cb_data, struct hey_action_ctx *ctx, size_t len, uint8_t *value, void **user_context)
{
    int32_t ret = -1;
    Iot__Service__Toothbrush__ActionInGetThreeAxisOfflineBrushingDetails *get_three_axis_offline_brushing_details = iot__service__toothbrush__action_in_get_three_axis_offline_brushing_details__unpack(NULL, len, value);
    if (NULL == get_three_axis_offline_brushing_details) {
        hey_action_stop(ctx);
        return EINVAL;
    }

    struct toothbrush_get_three_axis_offline_brushing_details_in action = { 0 };
    action.begintime = get_three_axis_offline_brushing_details->begintime;
    ret = toothbrush_get_three_axis_offline_brushing_details_start_cb(ctx, &action, user_context);

    iot__service__toothbrush__action_in_get_three_axis_offline_brushing_details__free_unpacked(get_three_axis_offline_brushing_details, NULL);
    return ret;
}

static void action_get_three_axis_offline_brushing_details_stop_cb(void *cb_data, void *user_context)
{
    toothbrush_get_three_axis_offline_brushing_details_stop_cb(user_context);
}

/**
 * @brief get three axis offline brushing details action send message of toothbrush service
 * @param ctx      [action context]
 * @param action   [get three axis offline brushing details action out]
 * @return int32_t [action send result, 0 means success]
 */
int32_t toothbrush_get_three_axis_offline_brushing_details_send(struct hey_action_ctx *ctx, struct toothbrush_get_three_axis_offline_brushing_details_out *action)
{
    int32_t ret = 0;
    Iot__Service__Toothbrush__ActionOutGetThreeAxisOfflineBrushingDetails *out = NULL;
    uint8_t *buf = NULL;
    out = malloc(sizeof(Iot__Service__Toothbrush__ActionOutGetThreeAxisOfflineBrushingDetails));
    if (NULL == out) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__toothbrush__action_out_get_three_axis_offline_brushing_details__init(out);
    if (action->n_data) {
        out->n_data  = action->n_data;
        out->data = calloc(out->n_data, sizeof(Iot__Service__Toothbrush__ActionOutGetThreeAxisOfflineBrushingDetails__Data *));
        if (NULL == out->data) {
            ret = ENOMEM;
            goto out;
        }
        for (int i = 0; i < out->n_data; i++) {
            out->data[i] = malloc(sizeof(Iot__Service__Toothbrush__ActionOutGetThreeAxisOfflineBrushingDetails__Data));
            if (NULL == out->data[i]) {
                ret = ENOMEM;
                goto out;
            }
            iot__service__toothbrush__action_out_get_three_axis_offline_brushing_details__data__init(out->data[i]);
            out->data[i]->score = action->data[i]->score;
            out->data[i]->utc = action->data[i]->utc;
            out->data[i]->totalduration = action->data[i]->totalduration;
            out->data[i]->cleaningrate = action->data[i]->cleaningrate;
            out->data[i]->errorduration = action->data[i]->errorduration;
            out->data[i]->largeshaketimes = action->data[i]->largeshaketimes;
        }
    }
    size_t buf_len = iot__service__toothbrush__action_out_get_three_axis_offline_brushing_details__get_packed_size(out);
    if (buf_len > 0) {
        buf = malloc(buf_len);
        if (NULL == buf) {
            ret = ENOMEM;
            goto out;
        }
    }
    iot__service__toothbrush__action_out_get_three_axis_offline_brushing_details__pack(out, buf);
    ret = hey_action_msg_send(ctx, buf_len, buf);

out:
    if (out && out->data) {
        for (int i = 0; i < out->n_data; i++) {
            if (out->data[i] == NULL)
                break;
            free(out->data[i]);
        }
        free(out->data);
    }
    free(out);
    free(buf);
    return ret;
}

/**
 * @brief get three axis offline brushing details action stop of toothbrush service
 * @param ctx      [action context]
 * @return int32_t [action stop result, 0 means success]
 */
int32_t toothbrush_get_three_axis_offline_brushing_details_stop(struct hey_action_ctx *ctx)
{
    return hey_action_stop(ctx);
}

static int32_t action_get_online_brushing_details_start_cb(void *cb_data, struct hey_action_ctx *ctx, size_t len, uint8_t *value, void **user_context)
{
    int32_t ret = -1;
    Iot__Service__Toothbrush__ActionInGetOnlineBrushingDetails *get_online_brushing_details = iot__service__toothbrush__action_in_get_online_brushing_details__unpack(NULL, len, value);
    if (NULL == get_online_brushing_details) {
        hey_action_stop(ctx);
        return EINVAL;
    }

    struct toothbrush_get_online_brushing_details_in action = { 0 };
    action.begintime = get_online_brushing_details->begintime;
    ret = toothbrush_get_online_brushing_details_start_cb(ctx, &action, user_context);

    iot__service__toothbrush__action_in_get_online_brushing_details__free_unpacked(get_online_brushing_details, NULL);
    return ret;
}

static void action_get_online_brushing_details_stop_cb(void *cb_data, void *user_context)
{
    toothbrush_get_online_brushing_details_stop_cb(user_context);
}

/**
 * @brief get online brushing details action send message of toothbrush service
 * @param ctx      [action context]
 * @param action   [get online brushing details action out]
 * @return int32_t [action send result, 0 means success]
 */
int32_t toothbrush_get_online_brushing_details_send(struct hey_action_ctx *ctx, struct toothbrush_get_online_brushing_details_out *action)
{
    int32_t ret = 0;
    Iot__Service__Toothbrush__ActionOutGetOnlineBrushingDetails *out = NULL;
    uint8_t *buf = NULL;
    out = malloc(sizeof(Iot__Service__Toothbrush__ActionOutGetOnlineBrushingDetails));
    if (NULL == out) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__toothbrush__action_out_get_online_brushing_details__init(out);
    if (action->n_data) {
        out->n_data  = action->n_data;
        out->data = calloc(out->n_data, sizeof(Iot__Service__Toothbrush__ActionOutGetOnlineBrushingDetails__Data *));
        if (NULL == out->data) {
            ret = ENOMEM;
            goto out;
        }
        for (int i = 0; i < out->n_data; i++) {
            out->data[i] = malloc(sizeof(Iot__Service__Toothbrush__ActionOutGetOnlineBrushingDetails__Data));
            if (NULL == out->data[i]) {
                ret = ENOMEM;
                goto out;
            }
            iot__service__toothbrush__action_out_get_online_brushing_details__data__init(out->data[i]);
            out->data[i]->score = action->data[i]->score;
            out->data[i]->utc = action->data[i]->utc;
            out->data[i]->totalduration = action->data[i]->totalduration;
            if (action->data[i]->n_details) {
                out->data[i]->n_details = action->data[i]->n_details;
                out->data[i]->details = calloc(out->data[i]->n_details, sizeof(Iot__Service__Toothbrush__ActionOutGetThreeAxisOfflineBrushingDetails *));
                if (NULL == out->data[i]->details) {
                    ret = ENOMEM;
                    goto out;
                }
                for (int j = 0; j < out->data[i]->n_details; j++) {
                    out->data[i]->details[j] = malloc(sizeof(Iot__Service__Toothbrush__ActionOutGetThreeAxisOfflineBrushingDetails));
                    if (NULL == out->data[i]->details[j]) {
                        ret = ENOMEM;
                        goto out;
                    }
                    iot__service__toothbrush__action_out_get_three_axis_offline_brushing_details__init(out->data[i]->details[j]);
                    out->data[i]->details[j]->data->score = action->data[i]->details[j]->data->score;
                    out->data[i]->details[j]->data->utc = action->data[i]->details[j]->data->utc;
                    out->data[i]->details[j]->data->totalduration = action->data[i]->details[j]->data->totalduration;
                    out->data[i]->details[j]->data->cleaningrate = action->data[i]->details[j]->data->cleaningrate;
                    out->data[i]->details[j]->data->errorduration = action->data[i]->details[j]->data->errorduration;
                    out->data[i]->details[j]->data->largeshaketimes = action->data[i]->details[j]->data->largeshaketimes;
                }
            }
        }
    }
    size_t buf_len = iot__service__toothbrush__action_out_get_online_brushing_details__get_packed_size(out);
    if (buf_len > 0) {
        buf = malloc(buf_len);
        if (NULL == buf) {
            ret = ENOMEM;
            goto out;
        }
    }
    iot__service__toothbrush__action_out_get_online_brushing_details__pack(out, buf);
    ret = hey_action_msg_send(ctx, buf_len, buf);

out:
    if (out && out->data) {
        for (int i = 0; i < out->n_data; i++) {
            if (out->data[i] == NULL)
                break;
            if (out->data[i]->details) {
                for (int j = 0; j < out->data[i]->n_details; j++) {
                    if (out->data[i]->details[j] == NULL)
                        break;
                    free(out->data[i]->details[j]);
                }
                free(out->data[i]->details);
            }
            free(out->data[i]);
        }
        free(out->data);
    }
    free(out);
    free(buf);
    return ret;
}

/**
 * @brief get online brushing details action stop of toothbrush service
 * @param ctx      [action context]
 * @return int32_t [action stop result, 0 means success]
 */
int32_t toothbrush_get_online_brushing_details_stop(struct hey_action_ctx *ctx)
{
    return hey_action_stop(ctx);
}

static int32_t service_toothbrush_properties_write_cb(void *cb_data, size_t n_iid, uint32_t *iids,
                                                      size_t len, uint8_t *value)
{
    Iot__Service__Toothbrush__Properties *props = iot__service__toothbrush__properties__unpack(NULL, len, value);
    if (NULL == props) {
        return EINVAL;
    }

    int32_t ret = 0;
    struct toothbrush_properties properties = { 0 };
    struct toothbrush_brushing_monitoring brushingmonitoring = { 0 };
    if (props->brushingmonitoring) {
        brushingmonitoring.touch = props->brushingmonitoring->touch;
        brushingmonitoring.areatype = props->brushingmonitoring->areatype;
        brushingmonitoring.sidetype = props->brushingmonitoring->sidetype;
        brushingmonitoring.duration = props->brushingmonitoring->duration;
        brushingmonitoring.largeshaketimes = props->brushingmonitoring->largeshaketimes;
    }
    properties.toothbrushheadlefttimes = props->toothbrushheadlefttimes;
    properties.toothbrushcleanmodelevel = props->toothbrushcleanmodelevel;
    properties.toothbrushwhiteningmodelevel = props->toothbrushwhiteningmodelevel;
    properties.toothbrushsensitivemodelevel = props->toothbrushsensitivemodelevel;
    properties.toothbrushcaremodelevel = props->toothbrushcaremodelevel;
    properties.toothbrushmodepersional = props->toothbrushmodepersional;
    properties.setbrushingduration = props->setbrushingduration;
    properties.setbrushingstartposition = props->setbrushingstartposition;
    properties.toothbrushjobstatus = props->toothbrushjobstatus;
    properties.brushingmonitoring = &brushingmonitoring;
    properties.antisplashenabled = props->antisplashenabled;
    properties.havebrushingrecordlist = props->havebrushingrecordlist;
    ret = toothbrush_properties_write_cb(n_iid, iids, &properties);

    iot__service__toothbrush__properties__free_unpacked(props, NULL);
    return ret;
}

static const struct hey_properties_callbacks props_cbs = {
    .write = service_toothbrush_properties_write_cb
};

static const struct hey_action_ctx_callbacks toothbrush_head_reset_cbs = {
    .start = action_toothbrush_head_reset_start_cb,
    .stop = action_toothbrush_head_reset_stop_cb
};

static const struct hey_action_ctx_callbacks get_three_axis_offline_brushing_details_cbs = {
    .start = action_get_three_axis_offline_brushing_details_start_cb,
    .stop = action_get_three_axis_offline_brushing_details_stop_cb
};

static const struct hey_action_ctx_callbacks get_online_brushing_details_cbs = {
    .start = action_get_online_brushing_details_start_cb,
    .stop = action_get_online_brushing_details_stop_cb
};

static const struct hey_action_entry actions_iids[] = {
    [0] = { .iid = TOOTHBRUSH_ACTION_TOOTHBRUSH_HEAD_RESET, .type = HEY_ACTION_ONCE, .cbs = &toothbrush_head_reset_cbs },
    [1] = { .iid = TOOTHBRUSH_ACTION_GET_THREE_AXIS_OFFLINE_BRUSHING_DETAILS, .type = HEY_ACTION_IN_ONCE_OUT_STREAM, .cbs = &get_three_axis_offline_brushing_details_cbs },
    [2] = { .iid = TOOTHBRUSH_ACTION_GET_ONLINE_BRUSHING_DETAILS, .type = HEY_ACTION_ONCE, .cbs = &get_online_brushing_details_cbs },
};

static int toothbrush_service_register(Iot__Service__Toothbrush__Properties *props)
{
    uint8_t *buf;
    size_t buf_len;
    buf_len = iot__service__toothbrush__properties__get_packed_size(props);
    if (buf_len == 0) {
        buf = NULL;
    } else {
        buf = malloc(buf_len);
        if (!buf) {
            return ENOMEM;
        }
        iot__service__toothbrush__properties__pack(props, buf);
    }

    struct hey_schema_service schema_srv;
    hey_schema_service_init(&schema_srv);
    schema_srv.properties.iids = (struct hey_schema_property *)toothbrush_properties_iids;
    schema_srv.properties.n_iid = PROP_IID_CNT;
    schema_srv.properties.value = buf;
    schema_srv.properties.len = buf_len;
    schema_srv.properties.cbs = &props_cbs;
    schema_srv.actions.iids = (struct hey_action_entry *)actions_iids;
    schema_srv.actions.n_iid = ACT_IID_CNT;
    toothbrush_service = hey_service_register(TOOTHBRUSH_SERVICE, &schema_srv, NULL);
    if (NULL == toothbrush_service) {
        free(buf);
        return errno;
    }

    free(buf);
    return 0;
}

/**
 * @brief update properties of toothbrush service
 * @param count      [the number of properties to be updated]
 * @param enumerate  [the iid enumeration of properties to be updated]
 * @param properties [properties structure with updated content]
 * @return int32_t   [update result]
 */
int32_t toothbrush_properties_update(size_t count, uint32_t *enumerate, struct toothbrush_properties *properties)
{
    assert(count <= PROP_IID_CNT);
    if (NULL == properties) {
        return EINVAL;
    }

    int ret = 0;
    Iot__Service__Toothbrush__Properties *props = NULL;
    uint8_t *buf = NULL;
    Iot__Service__Toothbrush__BrushingMonitoring *brushingmonitoring = NULL;
    props = malloc(sizeof(Iot__Service__Toothbrush__Properties));
    if (NULL == props) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__toothbrush__properties__init(props);
    if (properties->brushingmonitoring) {
        brushingmonitoring = malloc(sizeof(Iot__Service__Toothbrush__BrushingMonitoring));
        if (NULL == brushingmonitoring) {
            ret = ENOMEM;
            goto out;
        }
        iot__service__toothbrush__brushing_monitoring__init(brushingmonitoring);
        brushingmonitoring->touch = properties->brushingmonitoring->touch;
        brushingmonitoring->areatype = properties->brushingmonitoring->areatype;
        brushingmonitoring->sidetype = properties->brushingmonitoring->sidetype;
        brushingmonitoring->duration = properties->brushingmonitoring->duration;
        brushingmonitoring->largeshaketimes = properties->brushingmonitoring->largeshaketimes;
    }
    props->toothbrushheadlefttimes = properties->toothbrushheadlefttimes;
    props->toothbrushcleanmodelevel = properties->toothbrushcleanmodelevel;
    props->toothbrushwhiteningmodelevel = properties->toothbrushwhiteningmodelevel;
    props->toothbrushsensitivemodelevel = properties->toothbrushsensitivemodelevel;
    props->toothbrushcaremodelevel = properties->toothbrushcaremodelevel;
    props->toothbrushmodepersional = properties->toothbrushmodepersional;
    props->setbrushingduration = properties->setbrushingduration;
    props->setbrushingstartposition = properties->setbrushingstartposition;
    props->toothbrushjobstatus = properties->toothbrushjobstatus;
    props->brushingmonitoring = brushingmonitoring;
    props->antisplashenabled = properties->antisplashenabled;
    props->havebrushingrecordlist = properties->havebrushingrecordlist;

    size_t buf_len;
    buf_len = iot__service__toothbrush__properties__get_packed_size(props);
    if (buf_len > 0) {
        buf = malloc(buf_len);
        if (NULL == buf) {
            ret = ENOMEM;
            goto out;
        }
        iot__service__toothbrush__properties__pack(props, buf);
    }

    struct hey_properties_content content = {
        .n_iid = count,
        .iids = enumerate,
        .len = buf_len,
        .value = buf
    };
    ret = hey_properties_update(toothbrush_service, &content);

out:
    free(props);
    free(buf);
    free(brushingmonitoring);
    return ret;
}

/**
 * @brief toothbrush service initialization
 * @param properties [toothbrush service properties]
 * @return int32_t   [initialize result]
*/
int32_t toothbrush_service_init(const struct toothbrush_properties *properties)
{
    int ret = 0;
    Iot__Service__Toothbrush__Properties *props = NULL;
    Iot__Service__Toothbrush__BrushingMonitoring *brushingmonitoring = NULL;
    props = malloc(sizeof(Iot__Service__Toothbrush__Properties));
    if (NULL == props) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__toothbrush__properties__init(props);
    if (NULL != properties) {
        if (properties->brushingmonitoring) {
            brushingmonitoring = malloc(sizeof(Iot__Service__Toothbrush__BrushingMonitoring));
            if (NULL == brushingmonitoring) {
                ret = ENOMEM;
                goto out;
            }
            iot__service__toothbrush__brushing_monitoring__init(brushingmonitoring);
            brushingmonitoring->touch = properties->brushingmonitoring->touch;
            brushingmonitoring->areatype = properties->brushingmonitoring->areatype;
            brushingmonitoring->sidetype = properties->brushingmonitoring->sidetype;
            brushingmonitoring->duration = properties->brushingmonitoring->duration;
            brushingmonitoring->largeshaketimes = properties->brushingmonitoring->largeshaketimes;
        }
        props->toothbrushheadlefttimes = properties->toothbrushheadlefttimes;
        props->toothbrushcleanmodelevel = properties->toothbrushcleanmodelevel;
        props->toothbrushwhiteningmodelevel = properties->toothbrushwhiteningmodelevel;
        props->toothbrushsensitivemodelevel = properties->toothbrushsensitivemodelevel;
        props->toothbrushcaremodelevel = properties->toothbrushcaremodelevel;
        props->toothbrushmodepersional = properties->toothbrushmodepersional;
        props->setbrushingduration = properties->setbrushingduration;
        props->setbrushingstartposition = properties->setbrushingstartposition;
        props->toothbrushjobstatus = properties->toothbrushjobstatus;
        props->brushingmonitoring = brushingmonitoring;
        props->antisplashenabled = properties->antisplashenabled;
        props->havebrushingrecordlist = properties->havebrushingrecordlist;
    }

    ret = toothbrush_service_register(props);

out:
    free(props);
    free(brushingmonitoring);
    return ret;
}
