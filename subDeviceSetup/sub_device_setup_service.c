/* Generated by the heythings model compiler.  DO NOT EDIT! */
/* Generated from: subDeviceSetup.proto */

#include <errno.h>
#include <assert.h>
#include "subDeviceSetup.pb-c.h"
#include "sub_device_setup_service.h"
#include "hey/schema.h"

#define SUB_DEVICE_SETUP_SERVICE (78 * 256)
#define ACT_IID_CNT 1

static struct hey_service *sub_device_setup_service;

static int32_t action_sub_device_setup_start_cb(void *cb_data, struct hey_action_ctx *ctx, size_t len, uint8_t *value, void **user_context)
{
    int32_t ret = -1;
    Iot__Service__SubDeviceSetup__ActionInSubDeviceSetup *sub_device_setup = iot__service__sub_device_setup__action_in_sub_device_setup__unpack(NULL, len, value);
    if (NULL == sub_device_setup) {
        hey_action_stop(ctx);
        return EINVAL;
    }

    struct sub_device_setup_sub_device_setup_in action = { 0 };
    action.devaddress = sub_device_setup->devaddress;
    action.domainid = sub_device_setup->domainid;
    action.domaincert.data = sub_device_setup->domaincert.data;
    action.domaincert.len = sub_device_setup->domaincert.len;
    action.domainkeypub.data = sub_device_setup->domainkeypub.data;
    action.domainkeypub.len = sub_device_setup->domainkeypub.len;
    action.domaindevbeaconkey.data = sub_device_setup->domaindevbeaconkey.data;
    action.domaindevbeaconkey.len = sub_device_setup->domaindevbeaconkey.len;
    action.domaindevbeaconiv.data = sub_device_setup->domaindevbeaconiv.data;
    action.domaindevbeaconiv.len = sub_device_setup->domaindevbeaconiv.len;
    ret = sub_device_setup_sub_device_setup_start_cb(ctx, &action, user_context);

    iot__service__sub_device_setup__action_in_sub_device_setup__free_unpacked(sub_device_setup, NULL);
    return ret;
}

static void action_sub_device_setup_stop_cb(void *cb_data, void *user_context)
{
    sub_device_setup_sub_device_setup_stop_cb(user_context);
}

/**
 * @brief sub device setup action send message of sub device setup service
 * @param ctx      [action context]
 * @param action   [sub device setup action out]
 * @return int32_t [action send result, 0 means success]
 */
int32_t sub_device_setup_sub_device_setup_send(struct hey_action_ctx *ctx, struct sub_device_setup_sub_device_setup_out *action)
{
    int32_t ret = 0;
    Iot__Service__SubDeviceSetup__ActionOutSubDeviceSetup *out = NULL;
    uint8_t *buf = NULL;
    out = malloc(sizeof(Iot__Service__SubDeviceSetup__ActionOutSubDeviceSetup));
    if (NULL == out) {
        ret = ENOMEM;
        goto out;
    }
    iot__service__sub_device_setup__action_out_sub_device_setup__init(out);
    out->code = action->code;
    size_t buf_len = iot__service__sub_device_setup__action_out_sub_device_setup__get_packed_size(out);
    if (buf_len > 0) {
        buf = malloc(buf_len);
        if (NULL == buf) {
            ret = ENOMEM;
            goto out;
        }
    }
    iot__service__sub_device_setup__action_out_sub_device_setup__pack(out, buf);
    ret = hey_action_msg_send(ctx, buf_len, buf);

out:
    free(out);
    free(buf);
    return ret;
}

/**
 * @brief sub device setup action stop of sub device setup service
 * @param ctx      [action context]
 * @return int32_t [action stop result, 0 means success]
 */
int32_t sub_device_setup_sub_device_setup_stop(struct hey_action_ctx *ctx)
{
    return hey_action_stop(ctx);
}

static const struct hey_action_ctx_callbacks sub_device_setup_cbs = {
    .start = action_sub_device_setup_start_cb,
    .stop = action_sub_device_setup_stop_cb
};

static const struct hey_action_entry actions_iids[] = {
    [0] = { .iid = SUB_DEVICE_SETUP_ACTION_SUB_DEVICE_SETUP, .type = HEY_ACTION_ONCE, .cbs = &sub_device_setup_cbs },
};

static int sub_device_setup_service_register(Iot__Service__SubDeviceSetup__Properties *props)
{
    struct hey_schema_service schema_srv;
    hey_schema_service_init(&schema_srv);
    schema_srv.actions.iids = (struct hey_action_entry *)actions_iids;
    schema_srv.actions.n_iid = ACT_IID_CNT;
    sub_device_setup_service = hey_service_register(SUB_DEVICE_SETUP_SERVICE, &schema_srv, NULL);
    if (NULL == sub_device_setup_service) {
        return errno;
    }

    return 0;
}

/**
 * @brief sub device setup service initialization
 * @param properties [sub device setup service properties]
 * @return int32_t   [initialize result]
*/
int32_t sub_device_setup_service_init(const struct sub_device_setup_properties *properties)
{
    return sub_device_setup_service_register(NULL);
}
